#version plus rapide modsecurity
# attention à la version de nginx https://nginx.org/download/nginx-1.25.2.tar.gz ou https://nginx.org/download/nginx-1.18.0.tar.gz
apt update && apt install -y wget git gcc make automake autoconf libtool libpcre3 libpcre3-dev libxml2 libxml2-dev libcurl4-gnutls-dev apache2-dev apt-utils build-essential libgeoip-dev liblmdb-dev pkgconf zlib1g-dev && mkdir -p modsecu && cd modsecu && wget https://nginx.org/download/nginx-1.25.2.tar.gz && wget https://github.com/SpiderLabs/ModSecurity/releases/download/v3.0.10/modsecurity-v3.0.10.tar.gz && tar -zxvf nginx-1.25.2.tar.gz && tar -zxvf modsecurity-v3.0.10.tar.gz && cd modsecurity-v3.0.10 && ./configure --enable-standalone-module && make -j8 && make install && cd .. && git clone --depth 1 https://github.com/SpiderLabs/ModSecurity-nginx.git && cd nginx-1.25.2 && ./configure --with-compat --add-dynamic-module=../ModSecurity-nginx/ && make -j8 && make modules && cp objs/ngx_http_modsecurity_module.so /etc/nginx/modules && nginx -t

#configuration de modsecurity plus les règles OWASP
nano /etc/nginx/nginx.conf
-->    load_module modules/ngx_http_modsecurity_module.so;
-->    http{modsecurity on; modsecurity_rules_file /etc/nginx/modsec/main.conf;}
mkdir /etc/nginx/modsec/
cp /modsecu/modsecurity-v3.0.10/modsecurity.conf-recommended /etc/nginx/modsec/modsecurity.conf
nano /etc/nginx/modsec/modsecurity.conf
-->  SecRuleEngine DetectionOnly --> SecRuleEngine On
-->  SecAuditLogParts ABIJDEFHZ --> SecAuditLogParts ABCEFHJKZ
nano /etc/nginx/modsec/main.conf
-->  Include /etc/nginx/modsec/modsecurity.conf
cp /modsecu/modsecurity-v3.0.10/unicode.mapping /etc/nginx/modsec/
cd /modsecu/
wget https://github.com/coreruleset/coreruleset/releases/download/v3.3.5/coreruleset-3.3.5.tar.gz
tar -zxvf coreruleset-3.3.5.tar.gz
mv coreruleset-3.3.4/ /etc/nginx/modsec/
cp /modsecu/coreruleset-3.3.5/crs-setup.conf.example /etc/nginx/modsec/crs-setup.conf
cd /etc/nginx/modsec/
mv coreruleset-3.3.5/crs-setup.conf.example coreruleset-3.3.5/crs-setup.conf
nano main.conf
-->  Include /etc/nginx/modsec/coreruleset-3.3.4/crs-setup.conf
-->  Include /etc/nginx/modsec/coreruleset-3.3.4/rules/*.conf
nginx -t

apt remove -y wget git gcc make automake autoconf libtool libpcre3 libpcre3-dev libxml2 libxml2-dev libcurl4-gnutls-dev apache2-dev apt-utils build-essential libgeoip-dev liblmdb-dev pkgconf zlib1g-dev && apt clean && apt auto-clean && apt auto-remove -y